<!DOCTYPE html>
<html>
<title>İdarəetmə paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../css/w3.css">
  <link rel="stylesheet" href="../css/bootstrap.min.css" >
  <style>
    .bar-item {
      font-size: 1.4em;
    }
    .disabled {
      pointer-events: none;
    }
  </style>
<body>
  <div class="w3-sidebar w3-bar-block w3-card w3-animate-left"
    style="display:none" id="mySidebar">
    <button class="w3-bar-item w3-button w3-large bar-item"
      onclick="closeBar()">&times; Bağla</button>
    <a href="adminIndex.html" class="w3-bar-item w3-button bar-item">Ana səhifə</a>
    <a href="addProduct.html" class="w3-bar-item w3-button bar-item">Əlavə et</a>
    <a href="editProduct.html" class="w3-bar-item w3-button bar-item">Düzəliş et</a>
    <a href="deleteProduct.html" class="w3-bar-item w3-button bar-item">Sil</a>
    <a href="listProducts.html" class="w3-bar-item w3-button bar-item">Bütün məhsullar</a>
    <a href="transactions.html" class="w3-bar-item w3-button bar-item">Əməliyyatlar</a>
  </div>

  <div id="main">
    <div class="w3-teal">
      <button id="openNav" class="w3-button w3-teal w3-xlarge" onclick="openBar()">
        &#9776; Məhsul əlavə et
      </button>
    </div>

    <!-- Content -->
    <div class="w3-container" id="mainContent">
      <div style="padding: 20px;">
        <div class="row" id="addProductSection">
          <div class="col-7">

            <div class="row">
              <div class="col">
                <input type="number" class="form-control" placeholder="Barkod (13 simvol)" id="barcode">
              </div>
              <div class="col">
                <input type="text" class="form-control" placeholder="Ad" id="name">
              </div>
            </div>

            <br>
            <div class="row">
              <div class="col">
                <input type="number" class="form-control price" placeholder="Sayı" id="count">
              </div>
              <div class="col">
                <select class="form-control" id="firms">
                </select>
              </div>
            </div>

            <br>
            <div class="row">
              <div class="col">
                <input type="text" class="form-control" placeholder="Alış qiyməti" id="pPrice">
              </div>
              <div class="col">
                <input type="text" class="form-control" placeholder="Satış qiyməti" id="sPrice">
              </div>
            </div>

            <br>
            <div class="row">
              <div class="col">
                <input type="text" class="form-control" placeholder="Ətraflı məlumat (maks: 300 simvol)" id="details">
              </div>
            </div>

            <br>
            <div class="row">
              <div class="col">
                <button class="btn btn-primary disabled" onclick="addProduct()" id="addBtn">
                  &#x2b; Əlavə et
                </button>
              </div>
            </div>

            <br>
            <div class="alert alert-success" role="alert"
              style="display: none; text-align: center;" id="success">
              Əməliyyat yerinə yetirildi.
            </div>
            <div class="alert alert-info" role="alert"
              style="display: none; text-align: center;" id="info">
              N/A
            </div>
            <div class="alert alert-danger" role="alert"
              style="display: none; text-align: center;" id="danger">
              Səhv baş verdi.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('barcode').focus();
    const fs = require('fs');
    const axios = require('axios');
    const moment = require('moment');

    // Read admin data from usrData file
    var usrData = {};
    fs.readFile('usrData', (err, data) => {
      if (err) {
        return console.error(err);
      }
      try {
        // Parse usrData
        usrData = JSON.parse(data.toString());
      } catch (e) {
        // On error disable barcode control
        document.getElementById('danger').style.display = 'block';
        document.getElementById('barcode').setAttribute('readonly', true);
        console.error('Fayldan admin məlumatlarını oxuyarkən səhv baş verdi.');
      }

      // Verify seller's token
      axios.get('http://localhost:5003/Auth/VerifyAdmin', {
        headers: {
            Authorization: usrData.token
        }
      }).then((response) => {
        document.getElementById('addBtn').classList.remove('disabled');
        loadFirms();
        console.log("authenticated");
      }).catch((err) => {
        console.error('Fayldan satıcı məlumatlarını oxuyarkən səhv baş verdi.');
        console.log(err);
      })
    });

    function loadFirms() {
      axios.get('http://localhost:5003/Firms/AllBrief', {
        headers: {
          Authorization: usrData.token
        }
      }).then((response) => {
        console.log(response);
        var firmsSelect = document.getElementById('firms');
        response.data.forEach((item, i) => {
          var firmOption = document.createElement('option');
          firmOption.innerText = item.name;
          firmOption.setAttribute('value', item.id);
          firmsSelect.add(firmOption);
        });
      }).catch((err) => {
        console.log(err);
      });

    }

    function addProduct() {
      var newProduct = {
        "barcode": document.getElementById('barcode').value,
        "name": document.getElementById('name').value,
        "count": parseInt(document.getElementById('count').value),
        "firmId": document.getElementById('firms').value,
        "salePrice": parseFloat(document.getElementById('sPrice').value),
        "purchasePrice": parseFloat(document.getElementById('pPrice').value),
        "details": document.getElementById('details').value,
        "entryDate": moment().format()
      }
      // POST to server
      const myHeaders = {
        'Content-Type': "application/json",
        'Authorization': usrData.token
      };
      console.log(newProduct);
      axios.post('http://localhost:5003/Products/Add', newProduct, {
        headers: myHeaders
      }).then((response) => {
        document.getElementById('success').style.display = 'block';
        document.getElementById('danger').style.display = 'none';
        document.getElementById('info').style.display = 'block';
        document.getElementById('info').innerText = response.message;
        console.log(response);
      }).catch((err) => {
        document.getElementById('danger').style.display = 'block';
        console.log(err);
      });
    }

    function openBar() {
      document.getElementById("main").style.marginLeft = "25%";
      document.getElementById("mySidebar").style.width = "25%";
      document.getElementById("mySidebar").style.display = "block";
      // document.getElementById("openNav").style.display = 'none';
    }
    function closeBar() {
      document.getElementById("main").style.marginLeft = "0%";
      document.getElementById("mySidebar").style.display = "none";
      // document.getElementById("openNav").style.display = "inline-block";
    }
  </script>
</body>
</html>
